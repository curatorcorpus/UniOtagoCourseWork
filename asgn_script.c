#pragma config(Sensor, S3,     Colour,         sensorEV3_Color, modeEV3Color_Color)
#pragma config(Sensor, S4,     Gyro,           sensorEV3_Gyro)
#pragma config(Motor,  motorB,          left,          tmotorEV3_Large, PIDControl, driveLeft, encoder)
#pragma config(Motor,  motorC,          right,         tmotorEV3_Large, PIDControl, driveRight, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

// Colours range from 0 to 7
// None    = 0
// Black   = 1
// Blue    = 2
// Green   = 3
// Yellow  = 4
// Red     = 5
// White   = 6
// Brown   = 7

void reset_motors()
{
	setMotorSpeed(motorB, 0);
	setMotorSpeed(motorC, 0);

	sleep(10);
}

void initial_step(int initial_rot, int speed)
{
	forward(1, rotations, 50);
}

void inital_pivot(){

	int speed = 30;//TODO: needs to be configured for our environment

	displayCenteredBigTextLine(4, "Rotating 90 Right");

	setMotorSpeed(motorB, speed);
	setMotorSpeed(motorC, -speed);
	sleep(500);//TODO: needs to be configured for our environment

	eraseDisplay();
}

void run_stage1()
{
	int black_count = 0;
	int motor_pow = 40;

	bool on_black = false;
	bool on_dotted_line = true;

	short current_color;

	while (true){

		setMotorSync(motorB, motorC, 0, motor_pow);
		current_color = SensorValue[Colour];

		// TODO: need to double check these
		if(current_color == 1) {
			if(!on_black && black_count < 15) {

				on_black = true;
				displayCenteredBigTextLine(4, "%f", ++black_count);
				playTone(700, 10);

			} else if(black_count >= 15){

				break;
			}
		} else {

			on_black = false;
		}

		sleep(100);
	}

	eraseDisplay();
}

// main task
task main()
{

	// movement parameters
	int speed = 20;
	int initial_revs = 2; //TODO: needs to be configured for our environment

	// initial movement from start tile to black line
	initial_step(initial_revs, speed); // TODO: needs to be configured for our environment
	inital_pivot();// TODO: needs to be configured for our environment
	reset_motors();

	run_stage1();
	reset_motors();
	/*
	run_stage2();
	reset_motors();
	*/

}
